# Issue #50: Reference Documentation

## Overview

This document contains all source files and references analyzed during the feature request creation. Use this to
re-analyze the codebase context when needed.

---

## Primary Input

### Target Schema (to be generated)

```
json-schema.json
```

**Purpose:** The complete JSON schema file that should be generated by the new system. Contains all definitions, root
properties, and complex constructs (oneOf, anyOf, if/then/else).

**Key sections:**

- Lines 1-15: Schema metadata ($schema, id, title, fileMatch)
- Lines 15-150: Root properties (documents, prompts, tools, import, variables, etc.)
- Lines 150-250: Source type with conditionals
- Lines 250-580: document, tool, prompt definitions
- Lines 580-1500: All source definitions (file, url, github, gitlab, git_diff, etc.)

---

## Existing Libraries

### spiral/json-schema-generator

```
vendor/spiral/json-schema-generator/
├── src/Generator.php
├── src/Schema.php
├── src/Schema/Definition.php
├── src/Schema/Property.php
├── src/Parser/
└── src/Validation/
```

**Files analyzed:**

- `vendor/spiral/json-schema-generator/src/Generator.php` - Main generator logic
- `vendor/spiral/json-schema-generator/src/Schema.php` - Schema representation
- `vendor/spiral/json-schema-generator/src/Schema/Definition.php` - Definition structure

**Conclusion:** Good for simple DTOs but lacks support for complex JSON Schema features (oneOf, anyOf, if/then/else, $
ref patterns). Custom implementation needed.

---

## Bootloader Patterns

### Registry Bootloaders

```
src/Source/Registry/SourceRegistryBootloader.php
src/Modifier/ModifierBootloader.php
```

**Pattern learned:** Singleton registry registration via `defineSingletons()`:

```php
public function defineSingletons(): array
{
    return [
        SourceRegistryInterface::class => SourceRegistry::class,
    ];
}
```

### Source Bootloaders

```
src/Source/File/FileSourceBootloader.php
src/Source/GitDiff/GitDiffSourceBootloader.php
src/Source/Url/UrlSourceBootloader.php
src/Source/Github/GithubSourceBootloader.php
src/Source/Gitlab/GitlabSourceBootloader.php
src/Source/Tree/TreeSourceBootloader.php
src/Source/Composer/ComposerSourceBootloader.php
src/Source/Docs/DocsSourceBootloader.php
src/Source/Text/TextSourceBootloader.php
```

**Pattern learned:** Registration in `init()` method with multiple registries:

```php
public function init(
    SourceFetcherBootloader $registry,
    SourceRegistryInterface $sourceRegistry,
    FileSourceFactory $factory,
): void {
    $registry->register(FileSourceFetcher::class);
    $sourceRegistry->register($factory);
}
```

### Modifier Bootloaders

```
src/Modifier/Sanitizer/SanitizerModifierBootloader.php
src/Modifier/PhpContentFilter/PhpContentFilterBootloader.php
src/Modifier/PhpDocs/PhpDocsModifierBootloader.php
```

**Pattern learned:** Simple `boot()` registration:

```php
public function boot(SourceModifierRegistry $registry): void
{
    $registry->register(new SanitizerModifier());
}
```

---

## Console Command Patterns

### Existing Commands

```
src/Console/BaseCommand.php
src/Console/SchemaCommand.php
src/Console/GenerateCommand.php
```

**Pattern learned from `BaseCommand`:**

- Extends `Spiral\Console\Command`
- Logger setup in `execute()` with scope binding
- Uses `#[Option]` attributes for CLI options

**Pattern learned from `SchemaCommand`:**

- Uses `#[AsCommand]` attribute for name/description
- `__invoke()` method as entry point
- Error handling with `Command::FAILURE`/`Command::SUCCESS`

**Pattern learned from `GenerateCommand`:**

- Complex scope binding for DI
- Multiple options with defaults
- Progress output formatting

---

## Registry Interfaces

### Source Registry

```
src/Source/Registry/SourceRegistryInterface.php
src/Source/Registry/SourceRegistry.php
src/Source/Registry/SourceProviderInterface.php
src/Source/Registry/SourceFactoryInterface.php
```

**Pattern learned:** Simple interface with `register()` method:

```php
interface SourceRegistryInterface
{
    public function register(SourceFactoryInterface $factory): self;
}
```

### Modifier Registry

```
src/Modifier/SourceModifierRegistry.php
src/Modifier/SourceModifierInterface.php
```

---

## Application Structure

### Kernel

```
src/Application/Kernel.php
```

**Key information:**

- Lines 65-97: `defineBootloaders()` - order of bootloader registration
- Shows all existing bootloaders and their grouping
- New bootloader should be added after source/modifier bootloaders

### Console Bootloader

```
src/Application/Bootloader/ConsoleBootloader.php
```

**Pattern learned:** Command registration via `addCommand()`:

```php
public function addCommand(string ...$commands): void
{
    foreach ($commands as $command) {
        $this->config->modify(
            ConsoleConfig::CONFIG,
            new Append('commands', null, $command),
        );
    }
}
```

### Config Loader Bootloader

```
src/Config/ConfigLoaderBootloader.php
```

**Pattern learned:** Plugin/merger registration pattern with arrays:

```php
private array $parserPlugins = [];

public function registerParserPlugin(ConfigParserPluginInterface $plugin): void
{
    $this->parserPlugins[] = $plugin;
}
```

---

## File Reading Commands

To re-analyze these files, use:

```bash
# Read primary schema
ctx:file-read path="json-schema.json"

# Read spiral library
ctx:file-read paths='["vendor/spiral/json-schema-generator/src/Generator.php", "vendor/spiral/json-schema-generator/src/Schema.php"]'

# Read bootloader patterns
ctx:file-read paths='["src/Source/Registry/SourceRegistryBootloader.php", "src/Source/File/FileSourceBootloader.php", "src/Modifier/ModifierBootloader.php"]'

# Read console patterns
ctx:file-read paths='["src/Console/BaseCommand.php", "src/Console/SchemaCommand.php", "src/Console/GenerateCommand.php"]'

# Read kernel
ctx:file-read path="src/Application/Kernel.php"

# Search for bootloaders
ctx:file-search query="class.*Bootloader.*extends" pattern="*.php" regex=true

# List source bootloaders
ctx:directory-list path="src/Source" depth=2 pattern="*Bootloader.php"
```

---

## Schema Structure Analysis

### JSON Schema Sections

| Lines     | Section             | Content                                                                       |
|-----------|---------------------|-------------------------------------------------------------------------------|
| 1-15      | Metadata            | $schema, id, title, description, fileMatch                                    |
| 16-25     | Root oneOf          | Required constraints (documents OR prompts OR tools)                          |
| 26-150    | Root properties     | $schema, tools, prompts, exclude, rag, variables, import, settings, documents |
| 150-180   | source definition   | Base with type enum and conditionals                                          |
| 180-350   | source anyOf        | Conditional schemas for each source type                                      |
| 350-450   | import definitions  | importFilter, import config variants                                          |
| 450-550   | tool definitions    | tool, httpRequest, toolCommand                                                |
| 550-580   | inputSchema         | JSON Schema for tool/prompt arguments                                         |
| 580-650   | prompt definition   | prompt with messages, extend, schema                                          |
| 650-750   | document definition | document with sources, modifiers, tags                                        |
| 750-850   | fileSource          | File source with all options                                                  |
| 850-900   | urlSource           | URL source with headers, selector                                             |
| 900-930   | textSource          | Simple text source                                                            |
| 930-1000  | githubSource        | GitHub repository source                                                      |
| 1000-1100 | gitlabSource        | GitLab with server config                                                     |
| 1100-1200 | gitDiffSource       | Git diff with render options                                                  |
| 1200-1250 | docsSource          | Documentation source                                                          |
| 1250-1350 | treeSource          | Tree visualization source                                                     |
| 1350-1450 | composerSource      | Composer packages source                                                      |
| 1450-1550 | mcpSource           | MCP server source                                                             |
| 1550-1700 | modifiers           | php-content-filter, php-docs, sanitizer                                       |
| 1700-1800 | shared definitions  | sourcePaths, filePattern, treeViewConfig, etc.                                |

### Complex Constructs Used

| Construct              | Usage Location                     | Example                                                                        |
|------------------------|------------------------------------|--------------------------------------------------------------------------------|
| `oneOf`                | Root, import, source type variants | `{"oneOf": [{"required": ["documents"]}, ...]}`                                |
| `anyOf`                | source definition                  | Multiple source type conditions                                                |
| `allOf`                | source with conditionals           | Base + type-specific                                                           |
| `if/then`              | source type discrimination         | `{"if": {"properties": {"type": {"const": "file"}}}, "then": {"$ref": "..."}}` |
| `$ref`                 | Everywhere                         | `{"$ref": "#/definitions/fileSource"}`                                         |
| `additionalProperties` | variables, headers                 | `{"additionalProperties": {"type": "string"}}`                                 |
| `pattern`              | outputPath                         | `"^[\\w\\-./]+\\.[\\w]+$"`                                                     |
| `format`               | urls                               | `"format": "uri"`                                                              |
| `enum`                 | source type, visibility            | `["file", "url", "text", ...]`                                                 |
| `default`              | Most properties                    | `"default": true`                                                              |

---

## Key Decisions Made

1. **Custom implementation over spiral/json-schema-generator**
    - Reason: Need oneOf, anyOf, allOf, if/then/else, complex $ref patterns
    - Reference: `vendor/spiral/json-schema-generator/src/Generator.php` - no support for combinators

2. **Registry pattern with singleton**
    - Reason: Consistent with existing SourceRegistry, ModifierRegistry patterns
    - Reference: `src/Source/Registry/SourceRegistryBootloader.php`

3. **Schema registration in existing bootloaders**
    - Reason: Co-locate schema with feature code, no separate "schema bootloaders"
    - Reference: `src/Source/File/FileSourceBootloader.php` - already has init() with multiple registries

4. **Fluent builder API**
    - Reason: Readable, IDE-friendly, matches property definition flow
    - Reference: Schema structure in `json-schema.json` - nested properties are natural

5. **Build-time reference validation**
    - Reason: Catch missing definitions before commit, fail fast
    - Reference: Complex $ref network in `json-schema.json` - easy to miss

6. **Sorted definition output**
    - Reason: Deterministic, diff-friendly
    - Reference: Existing `json-schema.json` has unsorted definitions

---

## Testing References

### Existing Test Patterns

```
tests/Unit/
tests/Integration/
tests/Feature/
```

To find test patterns:

```bash
ctx:directory-list path="tests" depth=2
ctx:file-search query="class.*Test.*extends" pattern="*.php" path="tests" regex=true
```

### Validation Tools

- `ajv` - JSON Schema validator CLI
- `justinrainbow/json-schema` - PHP JSON Schema validator (if needed)
