<?php

declare(strict_types=1);

namespace Tests\Feature\Console\GenerateCommand;

use PHPUnit\Framework\Attributes\DataProvider;
use PHPUnit\Framework\Attributes\Test;
use Tests\Feature\Console\ConsoleTestCase;

final class PromptsTest extends ConsoleTestCase
{
    private string $outputDir;

    public static function commandsProvider(): \Generator
    {
        yield 'generate' => ['generate'];
        yield 'build' => ['build'];
        yield 'compile' => ['compile'];
    }

    #[Test]
    #[DataProvider('commandsProvider')]
    public function basic_prompts_should_be_compiled(string $command): void
    {
        // Create a basic prompt configuration file
        $configFile = $this->createTempFile(
            <<<'YAML'
                prompts:
                  - id: test-prompt
                    description: "A simple test prompt"
                    schema:
                      properties:
                        name:
                          description: "User's name"
                      required:
                        - name
                    messages:
                      - role: user
                        content: "Hello {{name}}, this is a test prompt."
                YAML,
            '.yaml',
        );

        $this
            ->buildContext(
                workDir: $this->outputDir,
                configPath: $configFile,
                command: $command,
            )
            ->assertSuccess()
            ->assertPromptExists(id: 'test-prompt')
            ->assertPrompt(id: 'test-prompt', properties: [
                'type' => 'prompt',
                'description' => 'A simple test prompt',
            ])
            ->assertPromptMessages(id: 'test-prompt', messageContents: [
                'Hello {{name}}, this is a test prompt.',
            ])
            ->assertPromptSchema(
                id: 'test-prompt',
                properties: [
                    'name' => ['description' => "User's name"],
                ],
                required: ['name'],
            );
    }

    #[Test]
    #[DataProvider('commandsProvider')]
    public function multiple_prompts_should_be_compiled(string $command): void
    {
        // Create a configuration with multiple prompts
        $configFile = $this->createTempFile(
            <<<'YAML'
                prompts:
                  - id: first-prompt
                    description: "First test prompt"
                    schema:
                      properties:
                        name:
                          description: "User's name"
                      required:
                        - name
                    messages:
                      - role: user
                        content: "Hello {{name}}, this is the first prompt."

                  - id: second-prompt
                    description: "Second test prompt"
                    schema:
                      properties:
                        query:
                          description: "User's query"
                      required:
                        - query
                    messages:
                      - role: assistant
                        content: "I'll help you with: {{query}}"
                YAML,
            '.yaml',
        );

        $this
            ->buildContext(
                workDir: $this->outputDir,
                configPath: $configFile,
                command: $command,
            )
            ->assertSuccess()
            ->assertPromptCount(count: 2)
            ->assertPromptExists(id: 'first-prompt')
            ->assertPromptExists(id: 'second-prompt')
            ->assertPrompt(id: 'first-prompt', properties: [
                'type' => 'prompt',
                'description' => 'First test prompt',
            ])
            ->assertPrompt(id: 'second-prompt', properties: [
                'type' => 'prompt',
                'description' => 'Second test prompt',
            ]);
    }

    #[Test]
    #[DataProvider('commandsProvider')]
    public function prompt_templates_should_be_compiled(string $command): void
    {
        // Create a configuration with template and prompt that extends it
        $configFile = $this->createTempFile(
            <<<'YAML'
                prompts:
                  - id: base-template
                    type: template
                    messages:
                      - role: user
                        content: "This is a base template with {{variable}}."

                  - id: extended-prompt
                    type: prompt
                    description: "Prompt that extends a template"
                    extend:
                      - id: base-template
                        arguments:
                          variable: "custom value"
                    schema:
                      properties:
                        additionalVar:
                          description: "Additional parameter"
                      required:
                        - additionalVar
                    messages:
                      - role: user
                        content: "Additional message with {{additionalVar}}."
                YAML,
            '.yaml',
        );

        $this
            ->buildContext(
                workDir: $this->outputDir,
                configPath: $configFile,
                command: $command,
            )
            ->assertSuccess()
            ->assertPromptExists(id: 'extended-prompt')
            ->assertPrompt(id: 'extended-prompt', properties: [
                'type' => 'prompt',
                'description' => 'Prompt that extends a template',
            ])
            ->assertPromptExtends(id: 'extended-prompt', templateId: 'base-template')
            ->assertPromptTemplateArguments(id: 'extended-prompt', templateId: 'base-template', arguments: [
                'variable' => 'custom value',
            ])
            ->assertPromptMessages(id: 'extended-prompt', messageContents: [
                'This is a base template with custom value.',
                'Additional message with {{additionalVar}}.',
            ])
            ->assertPromptSchema(
                id: 'extended-prompt',
                properties: [
                    'additionalVar' => ['description' => 'Additional parameter'],
                ],
                required: ['additionalVar'],
            );
    }

    #[Test]
    #[DataProvider('commandsProvider')]
    public function complex_prompt_inheritance_should_be_compiled(string $command): void
    {
        // Create a configuration with multiple levels of template inheritance
        $configFile = $this->createTempFile(
            <<<'YAML'
                prompts:
                  - id: base-template
                    type: template
                    messages:
                      - role: user
                        content: "Base content with {{baseVar}}."

                  - id: intermediate-template
                    type: template
                    extend:
                      - id: base-template
                        arguments:
                          baseVar: "{{intermediateVar}}"
                    messages:
                      - role: user
                        content: "Intermediate content with {{intermediateVar}}."

                  - id: final-prompt
                    type: prompt
                    description: "Multi-level inherited prompt"
                    extend:
                      - id: intermediate-template
                        arguments:
                          intermediateVar: "final value"
                    messages:
                      - role: user
                        content: "Final content."
                YAML,
            '.yaml',
        );

        $this
            ->buildContext(
                workDir: $this->outputDir,
                configPath: $configFile,
                command: $command,
            )
            ->assertSuccess()
            ->assertPromptExists(id: 'final-prompt')
            ->assertPromptExtends(id: 'final-prompt', templateId: 'intermediate-template')
            ->assertPromptTemplateArguments(id: 'final-prompt', templateId: 'intermediate-template', arguments: [
                'intermediateVar' => 'final value',
            ])
            ->assertPromptMessages(id: 'final-prompt', messageContents: [
                'Base content with final value.',
                'Intermediate content with final value.',
                'Final content.',
            ]);
    }

    #[Test]
    #[DataProvider('commandsProvider')]
    public function prompt_with_complex_schema_should_be_compiled(string $command): void
    {
        // Create a configuration with a complex schema
        $configFile = $this->createTempFile(
            <<<'YAML'
                prompts:
                  - id: complex-schema-prompt
                    description: "Prompt with complex schema"
                    schema:
                      properties:
                        title:
                          description: "Document title"
                        sections:
                          description: "Document sections"
                        author:
                          description: "Document author"
                        tags:
                          description: "Document tags"
                      required:
                        - title
                        - author
                    messages:
                      - role: user
                        content: "Create a document titled '{{title}}' by {{author}} with sections on {{sections}}. Tags: {{tags}}"
                YAML,
            '.yaml',
        );

        $this
            ->buildContext(
                workDir: $this->outputDir,
                configPath: $configFile,
                command: $command,
            )
            ->assertSuccess()
            ->assertPromptExists(id: 'complex-schema-prompt')
            ->assertPromptSchema(
                id: 'complex-schema-prompt',
                properties: [
                    'title' => ['description' => 'Document title'],
                    'sections' => ['description' => 'Document sections'],
                    'author' => ['description' => 'Document author'],
                    'tags' => ['description' => 'Document tags'],
                ],
                required: ['title', 'author'],
            );
    }

    #[Test]
    #[DataProvider('commandsProvider')]
    public function prompts_with_tags_should_be_compiled(string $command): void
    {
        // Create a configuration with prompts having tags
        $configFile = $this->createTempFile(
            <<<'YAML'
                prompts:
                  - id: coding-prompt
                    description: "Coding assistant prompt"
                    tags: ["coding", "development", "programming"]
                    messages:
                      - role: user
                        content: "Help me with coding."

                  - id: writing-prompt
                    description: "Writing assistant prompt"
                    tags: ["writing", "content", "creativity"]
                    messages:
                      - role: user
                        content: "Help me with writing."
                YAML,
            '.yaml',
        );

        $result = $this->buildContext(
            workDir: $this->outputDir,
            configPath: $configFile,
            command: $command,
        );

        $result->assertSuccess();

        // Get raw result to examine the tags
        $rawResult = $result->getResult();

        // Find the prompts in the result
        $codingPrompt = null;
        $writingPrompt = null;

        foreach ($rawResult['prompts'] as $prompt) {
            if ($prompt['id'] === 'coding-prompt') {
                $codingPrompt = $prompt;
            } elseif ($prompt['id'] === 'writing-prompt') {
                $writingPrompt = $prompt;
            }
        }

        // Assert the tags are present and correct
        $this->assertNotNull($codingPrompt, 'Coding prompt not found');
        $this->assertNotNull($writingPrompt, 'Writing prompt not found');

        $this->assertEquals(['coding', 'development', 'programming'], $codingPrompt['tags']);
        $this->assertEquals(['writing', 'content', 'creativity'], $writingPrompt['tags']);
    }

    #[Test]
    #[DataProvider('commandsProvider')]
    public function imported_prompts_should_be_compiled(string $command): void
    {
        // Create a base prompts file to be imported
        $basePromptsFile = $this->createTempFile(
            <<<'YAML'
                prompts:
                  - id: imported-template
                    type: template
                    description: "Imported template"
                    messages:
                      - role: user
                        content: "This template was imported from another file with {{importedVar}}."

                  - id: imported-prompt
                    description: "Imported standalone prompt"
                    schema:
                      properties:
                        query:
                          description: "User's query"
                      required:
                        - query
                    messages:
                      - role: assistant
                        content: "Imported prompt response for: {{query}}"
                YAML,
            '.yaml',
        );

        // Create a main config file that imports the base prompts
        $mainConfigFile = $this->createTempFile(
            <<<YAML
                import:
                  - path: {$this->getRelativePath($basePromptsFile)}
                    type: local

                prompts:
                  - id: main-prompt
                    description: "Main file prompt"
                    extend:
                      - id: imported-template
                        arguments:
                          importedVar: "successfully imported value"
                    messages:
                      - role: user
                        content: "Additional content from main file."
                YAML,
            '.yaml',
        );

        $this
            ->buildContext(
                workDir: $this->outputDir,
                configPath: $mainConfigFile,
                command: $command,
            )
            ->assertSuccess()
            ->assertImported(path: $this->getRelativePath($basePromptsFile), type: 'local')
            ->assertPromptCount(count: 2) // Only prompts, not templates, should be counted
            ->assertPromptExists(id: 'imported-prompt')
            ->assertPromptExists(id: 'main-prompt')
            ->assertPromptExtends(id: 'main-prompt', templateId: 'imported-template')
            ->assertPromptTemplateArguments(id: 'main-prompt', templateId: 'imported-template', arguments: [
                'importedVar' => 'successfully imported value',
            ])
            ->assertPromptMessages(id: 'main-prompt', messageContents: [
                'This template was imported from another file with successfully imported value.',
                'Additional content from main file.',
            ]);
    }

    #[Test]
    #[DataProvider('commandsProvider')]
    public function imported_prompts_with_filter_should_be_compiled(string $command): void
    {
        // Create a prompts file with multiple prompts to be selectively imported
        $promptsFile = $this->createTempFile(
            <<<'YAML'
                prompts:
                  - id: coding-helper
                    description: "Helps with coding tasks"
                    tags: ["coding", "development"]
                    messages:
                      - role: user
                        content: "I need help with coding."

                  - id: design-helper
                    description: "Helps with design tasks"
                    tags: ["design", "ui"]
                    messages:
                      - role: user
                        content: "I need help with design."

                  - id: advanced-coding
                    description: "Advanced coding assistance"
                    tags: ["coding", "advanced"]
                    messages:
                      - role: user
                        content: "I need advanced coding help."
                YAML,
            '.yaml',
        );

        // Create a main config that imports with a filter
        $mainConfigFile = $this->createTempFile(
            <<<YAML
                import:
                  - path: {$this->getRelativePath($promptsFile)}
                    type: local
                    filter:
                      tags:
                        include: ["coding"]
                        exclude: ["advanced"]

                prompts:
                  - id: local-prompt
                    description: "Local prompt"
                    messages:
                      - role: user
                        content: "This is a local prompt."
                YAML,
            '.yaml',
        );

        $this
            ->buildContext(
                workDir: $this->outputDir,
                configPath: $mainConfigFile,
                command: $command,
            )
            ->assertSuccess()
            ->assertImported(path: $this->getRelativePath($promptsFile), type: 'local')
            ->assertPromptCount(
                count: 2,
            ) // Local prompt + coding-helper (design-helper and advanced-coding should be filtered out)
            ->assertPromptExists(id: 'coding-helper')
            ->assertPromptExists(id: 'local-prompt')
            ->assertPrompt(id: 'coding-helper', properties: [
                'description' => 'Helps with coding tasks',
            ]);
    }

    #[Test]
    #[DataProvider('commandsProvider')]
    public function imported_prompts_with_ids_filter_should_be_compiled(string $command): void
    {
        // Create a prompts file with multiple prompts to be selectively imported by ID
        $promptsFile = $this->createTempFile(
            <<<'YAML'
                prompts:
                  - id: prompt-one
                    description: "First prompt"
                    messages:
                      - role: user
                        content: "This is the first prompt."

                  - id: prompt-two
                    description: "Second prompt"
                    messages:
                      - role: user
                        content: "This is the second prompt."

                  - id: prompt-three
                    description: "Third prompt"
                    messages:
                      - role: user
                        content: "This is the third prompt."
                YAML,
            '.yaml',
        );

        // Create a main config that imports specific prompts by ID
        $mainConfigFile = $this->createTempFile(
            <<<YAML
                import:
                  - path: {$this->getRelativePath($promptsFile)}
                    type: local
                    filter:
                      ids: ["prompt-one", "prompt-three"]

                prompts:
                  - id: local-prompt
                    description: "Local prompt"
                    messages:
                      - role: user
                        content: "This is a local prompt."
                YAML,
            '.yaml',
        );

        $this
            ->buildContext(
                workDir: $this->outputDir,
                configPath: $mainConfigFile,
                command: $command,
            )
            ->assertSuccess()
            ->assertImported(path: $this->getRelativePath($promptsFile), type: 'local')
            ->assertPromptCount(count: 3) // Local prompt + prompt-one + prompt-three
            ->assertPromptExists(id: 'prompt-one')
            ->assertPromptExists(id: 'prompt-three')
            ->assertPromptExists(id: 'local-prompt');
    }

    #[Test]
    #[DataProvider('commandsProvider')]
    public function invalid_prompt_should_report_error(string $command): void
    {
        // Create a configuration with an invalid prompt (missing required fields)
        $configFile = $this->createTempFile(
            <<<'YAML'
                prompts:
                  - id: invalid-prompt
                    # Missing description
                    # Missing messages
                YAML,
            '.yaml',
        );

        // Execute command which should report an error but not fail the process
        $result = $this->buildContext(
            workDir: $this->outputDir,
            configPath: $configFile,
            command: $command,
        );

        // At minimum, the prompt count should be 0
        $result->assertPromptCount(count: 0);
    }

    #[\Override]
    protected function setUp(): void
    {
        parent::setUp();
        $this->outputDir = $this->createTempDir();
    }

    protected function buildContext(
        string $workDir,
        ?string $configPath = null,
        ?string $inlineJson = null,
        ?string $envFile = null,
        string $command = 'generate',
        bool $asJson = true,
    ): CompilingResult {
        return (new ContextBuilder(console: $this->getConsole()))->build(
            workDir: $workDir,
            configPath: $configPath,
            inlineJson: $inlineJson,
            envFile: $envFile,
            command: $command,
            asJson: $asJson,
        );
    }

    private function getRelativePath(string $absolutePath): string
    {
        // Convert absolute path to relative path for use in YAML configurations
        // This ensures the test is independent of the absolute paths on the test system
        return \basename(path: $absolutePath);
    }
}
